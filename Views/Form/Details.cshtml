@model CTOM.ViewModels.Form.FormEditViewModel
@{
    ViewData["Title"] = "Chi tiết giao dịch";
}

<!-- CSS riêng cho trang Details -->
<link rel="stylesheet" href="~/css/form/form-details.css" asp-append-version="true" />

<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <i class="ti ti-eye me-2"></i>
                    @ViewData["Title"]
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <!-- Cấu trúc layout 2 cột đồng nhất -->
        @if (ViewData["ShowTemplateVersionWarning"] as bool? == true)
        {
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-title"><i class="ti ti-alert-triangle me-2"></i>Cảnh báo</h4>
                <div>
                    Template của biểu mẫu này đã có thay đổi sau khi giao dịch này được tạo. Một số trường dữ liệu có thể đã lỗi thời. Vui lòng kiểm tra kỹ trước khi sử dụng.
                </div>
                <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
            </div>
        }

        <div class="main-layout two-column">
            <!-- CỘT TRÁI: FORM CHỈ XEM -->
            <div class="form-input-area">
                <div class="card h-100 d-flex flex-column">
                    <div class="card-header py-2">
                        <h3 class="card-title mb-0">Thông tin dữ liệu</h3>
                    </div>
                    <div class="card-body overflow-auto">
                        <!-- Thông tin chung -->
                        <fieldset class="form-fieldset">
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Tên template</label>
                                <div class="col-sm-8">
                                    <input type="text" value="@Model.TemplateName" class="form-control bg-light" readonly />
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Ghi chú</label>
                                <div class="col-sm-8">
                                    <textarea class="form-control bg-light" rows="2" readonly>@Model.Note</textarea>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Trường động (read-only) -->
                        <fieldset class="form-fieldset mt-3">
                            <div id="dynamicFieldsContainer">
                                <div class="text-center p-5"><div class="spinner-border"></div></div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="card-footer text-end bg-white mt-auto">
                        <a asp-action="Index" class="btn btn-secondary me-auto">
                            <i class="ti ti-arrow-back me-2"></i>Danh sách
                        </a>
                        <button id="btnReview" type="button" class="btn btn-info" data-form-id="@Model.FormDataID" data-template-id="@Model.TemplateId">
                            <i class="ti ti-eye me-2"></i>Tài liệu đã lưu
                        </button>
                        <button id="btnDownload" type="button" class="btn btn-success" data-form-id="@Model.FormDataID" data-template-id="@Model.TemplateId">
                            <i class="ti ti-download me-2"></i>Tải file
                        </button>
                    </div>
                </div>
            </div>
            <!-- CỘT PHẢI: HTML PREVIEW -->
            <div class="preview-area">
                <div class="card h-100 d-flex flex-column">
                    <div class="card-header py-2">
                        <h3 class="card-title mb-0">Xem trước tài liệu</h3>
                    </div>
                    <div class="card-body" id="preview-pane-body">
                        <div class="document-preview" id="htmlPreviewContainer">
                            <div class="document-page" id="html-preview">
                                @* <div id="document-preview"> *@
                                    @if (Model.HasFile && !string.IsNullOrEmpty(Model.HtmlContent))
                                    {
                                        @Html.Raw(Model.HtmlContent)
                                    }
                                    else
                                    {
                                        <div class="text-center p-5 text-muted">
                                            <p class="mt-2">Không có nội dung xem trước cho template này.</p>
                                        </div>
                                    }
                                @* </div> *@
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal xem trước (giữ nguyên) -->
<div class="modal modal-blur fade" id="mergePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xem tài liệu đã lưu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="mergePreviewBody">
                <div class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">Đang xử lý...</p></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn me-auto" data-bs-dismiss="modal"><i class="ti ti-x me-2"></i>Đóng</button>
                <button type="button" class="btn btn-success" id="modalDownloadBtn" disabled><i class="ti ti-download me-2"></i>Tải file</button>
            </div>
        </div>
    </div>
</div>

<!-- ======================================================================= -->
<!-- MODAL XÁC NHẬN TÙY CHỈNH                                               -->
<!-- ======================================================================= -->

<div class="modal fade" id="customModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div id="modalStatus" class="modal-status bg-primary"></div>
            <div class="modal-body text-center py-4">
                <i id="modalIcon" class="ti ti-info-circle" style="font-size: 3rem;"></i>
                <h4 id="modalTitle" class="mt-2">Thông báo</h4>
                <div id="modalMessage" class="text-muted"></div>
            </div>
            <div class="modal-footer">
                <div class="w-100">
                    <div class="row">
                        <div class="col">
                            <button id="modalCancelBtn" type="button" class="btn w-100" data-bs-dismiss="modal">
                                <!-- Icon sẽ được thêm bằng JS -->
                            </button>
                        </div>
                        <div class="col">
                            <button id="modalConfirmBtn" type="button" class="btn btn-primary w-100">
                                <!-- Icon sẽ được thêm bằng JS -->
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Loại bỏ docx-preview.js -->
    <script src="~/lib/pizzip/dist/pizzip.min.js"></script>
    <script src="~/lib/docxtemplater/build/docxtemplater.js"></script>
    <script src="~/lib/file-saver/dist/FileSaver.min.js"></script>

    <!-- Truyền dữ liệu ban đầu -->
    <script>
        window.initialFormData = @Html.Raw(string.IsNullOrWhiteSpace(Model.FormDataJson) ? "{}" : Model.FormDataJson);
    </script>

    <!-- Sử dụng các file script đã nâng cấp -->
    <script src="~/js/form/form-common.js" asp-append-version="true"></script>
    <script src="~/js/form/form-details.js" asp-append-version="true"></script>
}
